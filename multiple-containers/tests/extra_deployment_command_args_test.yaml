# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test Extra Deployment command and args
templates:
  - deployment.yaml
  - extra_deployment.yaml
  - configmap.yaml
  - secret.yaml
tests:
  - it: Should have one deployment
    template: deployment.yaml
    asserts:
      - hasDocuments:
          count: 1 # because original deployment is created
  - it: Should have no extra deployment
    template: extra_deployment.yaml
    asserts:
      - hasDocuments:
          count: 0 # because original deployment is created
  - it: Should have one extra deployment with some containers with command and args
    values:
      - values/extra_deployment_container_command_args_envs.yaml
    release:
      name: my-release
    chart:
      appVersion: 10.100.1000
    set:
      nameOverride: myapp
    template: extra_deployment.yaml
    documentSelector:
      path: metadata.name
      values: deployment-one-my-release-myapp
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.containers[0].name
          value: app_with_env_and_env_from
      - notExists:
          path: spec.template.spec.containers[0].command
      - notExists:
          path: spec.template.spec.containers[0].args
      - equal:
          path: spec.template.spec.containers[2].name
          value: container_with_command
      - exists:
          path: spec.template.spec.containers[2].command
      - equal:
          path: spec.template.spec.containers[2].command
          value:
            - /bin/sh
            - -c
            - |
              echo "Starting application..."
              exec my-app
      - equal:
          path: spec.template.spec.containers[1].name
          value: container_with_args
      - exists:
          path: spec.template.spec.containers[1].args
      - equal:
          path: spec.template.spec.containers[1].args
          value:
            - --config
            - /etc/myapp/config.yaml  
            - --verbose 
