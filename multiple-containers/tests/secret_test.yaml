# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test Secret
templates:
  - secret.yaml
tests:
  - it: Should have no secret rendered when no env vars are defined
    asserts:
      - hasDocuments:
          count: 0
  - it: Should render secret with env vars from container config
    values:
      - values/container_config_secret_env.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    documentIndex: 0
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: app-my-release-myapp
      - equal:
          path: stringData
          value:
            MY_SECRET_VAR1: secret_value1
            MY_SECRET_VAR2: secret_value2

  - it: Should render Secret with secretEnv vars from job, cronjob and deployment
    values:
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_secret_env.yaml
      - values/extra_deployment_only_one.yaml    
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: secret.yaml
    asserts:
      - hasDocuments:
          count: 4

  - it: Check correct configmap rednering for Job
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_secret_env.yaml
      - values/extra_deployment_only_one.yaml          
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: secret.yaml
    documentSelector:
      path: metadata.name
      value: job1-container2-my-release-myapp
    asserts:
      - equal:
          path: stringData
          value:
            MY_SECRET_JOB_VAR: secret_job_value1

  - it: Check correct Secret rednering for CronJob
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_secret_env.yaml
      - values/extra_deployment_only_one.yaml          
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: secret.yaml
    documentSelector:
      path: metadata.name
      value: cronjob1-container2-my-release-myapp
    asserts:
      - equal:
          path: stringData
          value:
            MY_SECRET_CRONJOB_VAR: secret_cronjob_value1

  - it: Check correct Secret rednering for Deployment
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_secret_env.yaml
      - values/extra_deployment_only_one.yaml          
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: secret.yaml
    documentSelector:
      path: metadata.name
      value: deployment-one-container2-my-release-myapp
    asserts:
      - equal:
          path: stringData
          value:
            MY_SECRET_EXTRA_DEPLOYMENT_VAR: secret_value1


  - it: Check correct Secret rednering for Deployment
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_secret_env.yaml
      - values/extra_deployment_only_one.yaml          
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: secret.yaml
    documentSelector:
      path: metadata.name
      value: app-my-release-myapp
    asserts:
      - equal:
          path: stringData
          value:
            MY_SECRET_VAR1: secret_value1
            MY_SECRET_VAR2: secret_value2
