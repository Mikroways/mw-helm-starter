# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test PersistentVolumeClaim
templates:
  - pvc.yaml
tests:
  - it: Should have no pvc created when persistence is disabled
    asserts:
      - hasDocuments:
          count: 0
  - it: Should have no pvc created when using extra volumes
    values:
      - values/persistence_extra_mounts.yaml
    asserts:
      - hasDocuments:
          count: 0
  - it: Should render one pvc when persistence is enabled in one container
    values:
      - values/persistence.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    documentIndex: 0
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: metadata.name
          value: data-my-release-myapp
      - equal:
          path: metadata.annotations["example.com/annotation"]
          value: "true"
      - equal:
          path: spec
          value:
            accessModes:
              - "ReadWriteOnce"
            resources:
              requests:
                storage: 1Gi
            storageClassName: "storageclass"

  - it: Should render pvc for job, cronjob and deployment
    values:
      - values/persistence.yaml
      - values/cronjobs_multiple.yaml
      - values/jobs_multiple.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: pvc.yaml
    asserts:
      - hasDocuments:
          count: 3

  - it: Check correct PVC rednering for Job
    values:    
      - values/persistence.yaml
      - values/cronjobs_multiple.yaml
      - values/jobs_multiple.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: pvc.yaml
    documentSelector:
      path: metadata.name
      value: data-job-my-release-myapp
    asserts:
      - equal:
          path: metadata.annotations["example.com/job-annotation"]
          value: "other"
      - equal:
          path: spec
          value:
            accessModes:
              - "ReadWriteMany"
            resources:
              requests:
                storage: 10Gi
            storageClassName: "storageclass"

  - it: Check correct PVC rednering for CronJob
    values:    
      - values/persistence.yaml
      - values/cronjobs_multiple.yaml
      - values/jobs_multiple.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: pvc.yaml
    documentSelector:
      path: metadata.name
      value: data-cron-my-release-myapp
    asserts:
      - equal:
          path: metadata.annotations["example.com/cronjob-annotation"]
          value: "other annotation"
      - equal:
          path: spec
          value:
            accessModes:
              - "ReadOnlyMany"
            resources:
              requests:
                storage: 15Gi
            storageClassName: "storageclass"
