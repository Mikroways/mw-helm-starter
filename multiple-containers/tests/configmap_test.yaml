# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test Configmap
templates:
  - configmap.yaml
tests:
  - it: Should have no configmap rendered when no env vars are defined
    asserts:
      - hasDocuments:
          count: 0
  - it: Should render configmap with env vars from container config
    values:
      - values/container_config_env.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    tempalte: configmap.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: app-my-release-myapp
      - equal:
          path: data
          value:
            MY_VAR1: value1
            MY_VAR2: value2
      - equal:
          path: metadata.annotations
          value:
            some: annotation
            
  - it: Should render configmap with env vars from job, cronjob, deployment and extra_deployment
    values:
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_env.yaml
      - values/extra_deployment_only_one.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: configmap.yaml
    asserts:
      - hasDocuments:
          count: 4

  - it: Check correct configmap rendering for Job
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_env.yaml
      - values/extra_deployment_only_one.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: configmap.yaml
    documentSelector:
      path: metadata.name
      value: job1-container2-my-release-myapp
    asserts:
      - equal:
          path: data
          value:
            MY_JOB_VAR1: job_value1
            MY_JOB_VAR2: job_value2
  - it: Check correct configmap rendering for CronJob
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_env.yaml
      - values/extra_deployment_only_one.yaml
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: configmap.yaml
    documentSelector:
      path: metadata.name
      value: cronjob1-container2-my-release-myapp
    asserts:
      - equal:
          path: data
          value:
            MY_CRONJOB_VAR1: cronjob_value1
            MY_CRONJOB_VAR2: cronjob_value2

  - it: Check correct configmap rendering for Extra Deployment
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_env.yaml
      - values/extra_deployment_only_one.yaml      
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: configmap.yaml
    documentSelector:
      path: metadata.name
      value: deployment-one-container2-my-release-myapp
    asserts:
      - equal:
          path: data
          value:
            MY_EXTRA_DEPLOYMENT_VAR1: value1
            MY_EXTRA_DEPLOYMENT_VAR2: value2

  - it: Check correct configmap rendering for Deployment
    values:    
      - values/jobs_only_one.yaml
      - values/cronjobs_only_one.yaml
      - values/container_config_env.yaml
      - values/extra_deployment_only_one.yaml      
    release:
      name: my-release
    set:
      nameOverride: myapp
    template: configmap.yaml
    documentSelector:
      path: metadata.name
      value: app-my-release-myapp
    asserts:
      - equal:
          path: data
          value:
            MY_VAR1: value1
            MY_VAR2: value2
